<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rise to Stardom: Legacy - Full Corrected v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { /* Default Theme CSS Variables */
            --bg-primary: #111827;       /* gray-900 */
            --bg-secondary: #1f2937;     /* gray-800 */
            --bg-tertiary: #374151;      /* gray-700 */
            --text-primary: #f9fafb;     /* gray-50 */
            --text-secondary: #d1d5db;   /* gray-300 */
            --text-muted: #9ca3af;       /* gray-400 */
            --accent-primary: #a855f7;   /* purple-500 */
            --accent-secondary: #eab308; /* yellow-500 */
            --border-color: #4b5563;    /* gray-600 */
            --button-primary-bg: var(--accent-primary);
            --button-primary-hover-bg: #9333ea; /* purple-600 */
            --button-secondary-bg: var(--bg-tertiary);
            --button-secondary-hover-bg: #4b5563; /* gray-600 */
            --danger-bg: #dc2626; /* red-600 */
            --danger-hover-bg: #b91c1c; /* red-700 */
            --progress-bar-bg: var(--accent-primary); /* Default progress to accent */
        }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: sans-serif; }
        /* Apply variables */
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }
        .text-accent-primary { color: var(--accent-primary); }
        .text-accent-secondary { color: var(--accent-secondary); }
        .border-accent-primary { border-color: var(--accent-primary); }
        .border-main { border-color: var(--border-color); }
        .ring-accent-primary { --tw-ring-color: var(--accent-primary); }
        .button-primary { background-color: var(--button-primary-bg); color: white; }
        .button-primary:hover { background-color: var(--button-primary-hover-bg); }
        .button-secondary { background-color: var(--button-secondary-bg); color: var(--text-primary); }
        .button-secondary:hover { background-color: var(--button-secondary-hover-bg); }
        .button-danger { background-color: var(--danger-bg); color: white; }
        .button-danger:hover { background-color: var(--danger-hover-bg); }
        .progress-bar-default { background-color: var(--progress-bar-bg); }

        /* Other styles */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .pulse { animation: pulse 2s infinite; }
        .number-ticker { transition: all 0.3s ease; }
        .progress-bar { transition: width 0.5s ease; background-color: var(--progress-bar-bg); }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hidden-file-input { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        .avatar-preview, .cover-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 2px solid var(--border-color); display: block; margin: 0 auto 1rem; background-color: var(--bg-tertiary); }
        .cover-preview { border-radius: 0.5rem; width: 128px; height: 128px; }
        .modal-cover-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 0.375rem; border: 1px solid var(--border-color); background-color: var(--bg-tertiary); }
        .custom-file-upload { border: 1px solid var(--border-color); display: inline-block; padding: 6px 12px; cursor: pointer; background-color: var(--bg-tertiary); border-radius: 0.375rem; transition: background-color 0.2s ease; }
        .custom-file-upload:hover { background-color: var(--button-secondary-hover-bg); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        .song-list { display: none; max-height: 150px; overflow-y: auto; padding-right: 0.5rem; /* Add padding for scrollbar */ }
        .song-list.expanded { display: block; }
    </style>
</head>
<body class="bg-primary text-primary min-h-screen">
    <!-- Settings Button -->
    <button id="settingsBtn" title="Settings" class="fixed top-4 right-4 z-50 p-2 bg-secondary rounded-full shadow-lg hover:bg-tertiary transition-colors">
        <i class="fas fa-cog text-xl text-muted"></i>
    </button>

    <!-- Game Container -->
    <div class="container mx-auto px-4 py-8" id="gameContainer">
        <!-- Character Creation Screen -->
        <div id="characterCreation" class="max-w-4xl mx-auto bg-secondary rounded-xl p-8 shadow-2xl">
            <h1 class="text-4xl font-bold text-center mb-8 text-accent-primary">Rise to Stardom: Legacy</h1>
            <!-- Character Creation Form... -->
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div> <h2 class="text-2xl font-semibold mb-4 text-accent-secondary">Details</h2> <div class="mb-6"> <label class="block text-secondary mb-2">Stage Name</label> <input type="text" id="stageName" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-2 ring-accent-primary"> </div> <div class="mb-6"> <label class="block text-secondary mb-2">Real Name</label> <input type="text" id="realName" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-2 ring-accent-primary"> </div> <div class="mb-6"> <label class="block text-secondary mb-2">Age</label> <select id="startingAge" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-2 ring-accent-primary"> <option value="18">18</option> <option value="22" selected>22</option> <option value="25">25</option> <option value="30">30</option> </select> </div> <div class="mb-6"> <label class="block text-secondary mb-2">Background</label> <select id="hometown" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-2 ring-accent-primary"> <option value="smallTown">Small Town</option> <option value="bigCity">Big City</option> <option value="suburbs">Suburban</option> <option value="international">International</option> </select> </div> </div>
                <div> <h2 class="text-2xl font-semibold mb-4 text-accent-secondary">Music</h2> <div class="mb-6"> <label class="block text-secondary mb-2">Primary Genre</label> <select id="primaryGenre" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-2 ring-accent-primary"> <option value="pop">Pop</option> <option value="rock">Rock</option> <option value="hiphop">Hip Hop</option> <option value="electronic">Electronic</option> <option value="r&b">R&B</option> <option value="indie">Indie</option> <option value="country">Country</option> <option value="alternative">Alternative</option> </select> </div> <div class="mb-6"> <label class="block text-secondary mb-2">Secondary Genre</label> <select id="secondaryGenre" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-2 ring-accent-primary"> <option value="none">None</option> <option value="pop">Pop</option> <option value="rock">Rock</option> <option value="hiphop">Hip Hop</option> <option value="electronic">Electronic</option> <option value="r&b">R&B</option> <option value="indie">Indie</option> <option value="country">Country</option> <option value="alternative">Alternative</option> </select> </div> <div class="mb-6"> <label class="block text-secondary mb-2">Style</label> <select id="startingStyle" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-2 ring-accent-primary"> <option value="grungy">Grungy</option> <option value="polished">Polished</option> <option value="bohemian">Bohemian</option> <option value="street">Street</option> <option value="glam">Glam</option> <option value="minimalist">Minimalist</option> </select> </div> <div class="mb-6"> <label class="block text-secondary mb-2">Talent</label> <select id="innateTalent" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-2 ring-accent-primary"> <option value="charisma">Charisma</option> <option value="prodigy">Prodigy</option> <option value="technical">Technical Ear</option> <option value="lyricism">Lyricist</option> <option value="stage">Stage Presence</option> </select> </div> </div>
            </div>
            <div class="mt-8"> <h2 class="text-2xl font-semibold mb-4 text-accent-secondary">Look</h2> <div class="text-center"> <img id="avatarPreview" src="https://via.placeholder.com/100?text=Avatar" alt="Avatar Preview" class="avatar-preview"> <label for="avatarUpload" class="custom-file-upload"> <i class="fas fa-upload mr-2"></i> Upload </label> <input type="file" id="avatarUpload" accept="image/*" class="hidden-file-input"> <p class="text-xs text-muted mt-2">(Optional)</p> </div> <p class="text-center my-4 text-muted">-- OR Choose --</p> <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4"> <div class="avatar-option border-2 border-transparent hover:border-accent-primary rounded-lg p-2 cursor-pointer" data-avatar-url="https://randomuser.me/api/portraits/women/1.jpg"> <img src="https://randomuser.me/api/portraits/women/1.jpg" class="w-full rounded-lg"> </div> <div class="avatar-option border-2 border-transparent hover:border-accent-primary rounded-lg p-2 cursor-pointer" data-avatar-url="https://randomuser.me/api/portraits/men/1.jpg"> <img src="https://randomuser.me/api/portraits/men/1.jpg" class="w-full rounded-lg"> </div> <div class="avatar-option border-2 border-transparent hover:border-accent-primary rounded-lg p-2 cursor-pointer" data-avatar-url="https://randomuser.me/api/portraits/women/2.jpg"> <img src="https://randomuser.me/api/portraits/women/2.jpg" class="w-full rounded-lg"> </div> <div class="avatar-option border-2 border-transparent hover:border-accent-primary rounded-lg p-2 cursor-pointer" data-avatar-url="https://randomuser.me/api/portraits/men/2.jpg"> <img src="https://randomuser.me/api/portraits/men/2.jpg" class="w-full rounded-lg"> </div> </div> </div>
            <div class="mt-12 text-center"> <button id="startGameBtn" class="button-primary font-bold py-3 px-8 rounded-full text-lg transition-transform transform hover:scale-105"> Begin Journey </button> </div>
        </div>

        <!-- Main Game Screen (Hidden Initially) -->
        <div id="mainGame" class="hidden">
            <!-- Header -->
            <div class="bg-secondary rounded-xl p-4 mb-6 shadow-lg">
                 <div class="flex flex-wrap items-center justify-between">
                    <div class="flex items-center space-x-4 mb-4 md:mb-0"> <img id="playerAvatar" src="" class="w-12 h-12 rounded-full border-2 border-accent-primary object-cover"> <div> <h2 id="playerStageName" class="font-bold text-lg"></h2> <p id="playerGenre" class="text-muted text-sm"></p> </div> </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full md:w-auto">
                        <div class="bg-tertiary rounded-lg p-3 text-center"> <p class="text-muted text-xs">Subs</p> <p id="subscriberCount" class="font-bold text-xl number-ticker">0</p> </div>
                        <div class="bg-tertiary rounded-lg p-3 text-center"> <p class="text-muted text-xs">Streams</p> <p id="streamCount" class="font-bold text-xl number-ticker">0</p> </div>
                        <div class="bg-tertiary rounded-lg p-3 text-center"> <p class="text-muted text-xs">Income</p> <p id="incomeCount" class="font-bold text-xl number-ticker">$0</p> </div>
                        <div class="bg-tertiary rounded-lg p-3 text-center"> <p class="text-muted text-xs">Fame</p> <div class="flex items-center justify-center space-x-1"> <i class="fas fa-star text-yellow-400"></i> <p id="fameLevel" class="font-bold">Unknown</p> </div> </div>
                    </div>
                </div>
            </div>
            <!-- Main Content Area -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Left Sidebar -->
                <div class="lg:col-span-1 space-y-6">
                     <div class="bg-secondary rounded-xl p-6 shadow-lg"> <h3 class="font-bold text-lg mb-4 text-accent-primary">Stats</h3> <div class="space-y-4"> <div> <div class="flex justify-between mb-1"> <span class="text-sm">Vocals</span> <span id="vocalSkillValue" class="text-sm">0</span> </div> <div class="w-full bg-tertiary rounded-full h-2.5"> <div id="vocalSkillBar" class="bg-blue-500 h-2.5 rounded-full progress-bar progress-bar-default" style="width: 0%"></div> </div> </div> <div> <div class="flex justify-between mb-1"> <span class="text-sm">Writing</span> <span id="songwritingSkillValue" class="text-sm">0</span> </div> <div class="w-full bg-tertiary rounded-full h-2.5"> <div id="songwritingSkillBar" class="bg-green-500 h-2.5 rounded-full progress-bar progress-bar-default" style="width: 0%"></div> </div> </div> <div> <div class="flex justify-between mb-1"> <span class="text-sm">Prod</span> <span id="productionSkillValue" class="text-sm">0</span> </div> <div class="w-full bg-tertiary rounded-full h-2.5"> <div id="productionSkillBar" class="bg-yellow-500 h-2.5 rounded-full progress-bar progress-bar-default" style="width: 0%"></div> </div> </div> <div> <div class="flex justify-between mb-1"> <span class="text-sm">Stage</span> <span id="stageSkillValue" class="text-sm">0</span> </div> <div class="w-full bg-tertiary rounded-full h-2.5"> <div id="stageSkillBar" class="bg-purple-500 h-2.5 rounded-full progress-bar progress-bar-default" style="width: 0%"></div> </div> </div> </div> <h3 class="font-bold text-lg mt-6 mb-4 text-accent-primary">Wellbeing</h3> <div class="space-y-4"> <div> <div class="flex justify-between mb-1"> <span class="text-sm">Energy</span> <span id="energyValue" class="text-sm">0</span> </div> <div class="w-full bg-tertiary rounded-full h-2.5"> <div id="energyBar" class="bg-blue-400 h-2.5 rounded-full progress-bar progress-bar-default" style="width: 0%"></div> </div> </div> <div> <div class="flex justify-between mb-1"> <span class="text-sm">Mental</span> <span id="mentalHealthValue" class="text-sm">0</span> </div> <div class="w-full bg-tertiary rounded-full h-2.5"> <div id="mentalHealthBar" class="bg-green-400 h-2.5 rounded-full progress-bar progress-bar-default" style="width: 0%"></div> </div> </div> <div> <div class="flex justify-between mb-1"> <span class="text-sm">Image</span> <span id="publicImageValue" class="text-sm">0</span> </div> <div class="w-full bg-tertiary rounded-full h-2.5"> <div id="publicImageBar" class="bg-purple-400 h-2.5 rounded-full progress-bar progress-bar-default" style="width: 0%"></div> </div> </div> </div> </div>
                     <div class="bg-secondary rounded-xl p-6 shadow-lg"> <h3 class="font-bold text-lg mb-4 text-accent-primary">Actions</h3> <div class="space-y-3"> <button id="practiceVocalsBtn" class="w-full button-secondary text-sm py-2 px-3 rounded-lg flex items-center justify-between"> <span>Practice Vocals</span> <i class="fas fa-microphone"></i> </button> <button id="writeSongBtn" class="w-full button-secondary text-sm py-2 px-3 rounded-lg flex items-center justify-between"> <span>Write Song</span> <i class="fas fa-music"></i> </button> <button id="produceTrackBtn" class="w-full button-secondary text-sm py-2 px-3 rounded-lg flex items-center justify-between"> <span>Produce Track</span> <i class="fas fa-sliders-h"></i> </button> <button id="restBtn" class="w-full button-secondary text-sm py-2 px-3 rounded-lg flex items-center justify-between"> <span>Rest</span> <i class="fas fa-bed"></i> </button> </div> </div>
                     <div class="bg-secondary rounded-xl p-6 shadow-lg"> <h3 class="font-bold text-lg mb-4 text-accent-primary">Promotion</h3> <div class="space-y-3"> <button id="promoteSocialMediaBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm py-2 px-3 rounded-lg flex items-center justify-between"> <span>Social Blitz ($<span id="promoCostSocial">0</span>)</span> <i class="fas fa-bullhorn"></i> </button> <p class="text-xs text-muted italic">More campaigns later!</p> </div> </div>
                </div>
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-6">
                     <div class="bg-secondary rounded-xl p-6 shadow-lg"> <h3 class="font-bold text-lg mb-4 text-accent-primary">Studio</h3> <div id="noProject"> <div class="text-center py-8"> <i class="fas fa-compact-disc text-5xl text-gray-600 mb-4"></i> <p class="text-muted">Ready to create?</p> <button id="startProjectBtn" class="mt-4 button-primary font-bold py-2 px-6 rounded-full"> Start New Project </button> </div> </div> <div id="activeProject" class="hidden"> <h4 class="font-semibold text-lg mb-2">Current Project:</h4> <div class="flex items-start space-x-4"> <div class="bg-tertiary rounded-lg p-2 w-24 h-24 flex items-center justify-center"> <img id="projectCoverPreview" src="" alt="Cover" class="w-full h-full object-cover rounded-md"> </div> <div class="flex-1"> <h4 id="projectTitle" class="font-bold text-lg"></h4> <p id="projectType" class="text-muted text-sm mb-2"></p> <div class="flex space-x-2 mb-3"> <span id="projectStage" class="bg-tertiary text-xs px-2 py-1 rounded"></span> </div> <div class="w-full bg-tertiary rounded-full h-2 mb-2"> <div id="projectProgressBar" class="h-2 rounded-full progress-bar progress-bar-default" style="width: 0%"></div> </div> <p id="projectProgressText" class="text-right text-xs text-muted">0%</p> </div> </div> <div class="mt-6 grid grid-cols-2 gap-4"> <button id="workOnProjectBtn" class="button-primary py-2 px-4 rounded-lg"> Work </button> <button id="cancelProjectBtn" class="button-secondary py-2 px-4 rounded-lg"> Cancel </button> </div> </div> </div>
                     <div id="catalogueSection" class="bg-secondary rounded-xl p-6 shadow-lg"> <h3 class="font-bold text-lg mb-4 text-accent-primary">Catalogue</h3> <div id="catalogueList" class="space-y-3 max-h-60 overflow-y-auto pr-2"> <p class="text-muted italic">No releases yet.</p> </div> </div>
                     <div class="bg-secondary rounded-xl p-6 shadow-lg"> <div class="flex justify-between items-center mb-4"> <h3 class="font-bold text-lg text-accent-primary">Social Feed</h3> <div class="flex space-x-2"> <button id="refreshFeedBtn" title="Refresh Feed" class="button-secondary text-sm py-1 px-3 rounded-lg"> <i class="fas fa-sync-alt"></i> </button> </div> </div> <div class="mb-4 flex space-x-2"> <textarea id="customPostContent" rows="2" class="flex-grow bg-tertiary border border-main rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 ring-accent-primary" placeholder="Share an update..."></textarea> <button id="postUpdateBtn" class="button-primary px-4 rounded-lg text-sm self-start py-2">Post</button> </div> <div id="socialFeed" class="space-y-3 max-h-96 overflow-y-auto pr-2"> </div> </div>
                </div>
                <!-- Right Sidebar -->
                <div class="lg:col-span-1 space-y-6">
                     <div class="bg-secondary rounded-xl p-6 shadow-lg"> <div class="flex justify-between items-center mb-4"> <h3 class="font-bold text-lg text-accent-primary">Notifications</h3> <button id="clearNotificationsBtn" title="Clear All" class="text-muted hover:text-primary text-sm"> <i class="fas fa-trash-alt"></i> </button> </div> <div id="notificationsList" class="space-y-2 max-h-96 overflow-y-auto pr-2"> </div> </div>
                     <div class="bg-secondary rounded-xl p-6 shadow-lg"> <h3 class="font-bold text-lg mb-4 text-accent-primary">Upcoming</h3> <div id="upcomingEvents" class="space-y-3"> </div> </div>
                </div>
            </div>
        </div>

        <!-- Project Creation Modal -->
        <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4"> <div class="bg-secondary rounded-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto"> <div class="flex justify-between items-center mb-4"> <h3 class="text-xl font-bold text-accent-primary">New Project</h3> <button id="closeProjectModalBtn" class="text-muted hover:text-primary"> <i class="fas fa-times"></i> </button> </div> <div class="space-y-4"> <div> <label class="block text-secondary mb-2">Cover Art</label> <div class="flex items-center space-x-4"> <img id="modalCoverPreview" src="" alt="Cover" class="modal-cover-preview"> <div> <label for="coverArtUpload" class="custom-file-upload text-sm"> <i class="fas fa-upload mr-1"></i> Upload </label> <input type="file" id="coverArtUpload" accept="image/*" class="hidden-file-input"> </div> </div> </div> <div> <label class="block text-secondary mb-2">Type</label> <select id="projectTypeSelect" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-1 ring-accent-primary"> <option value="single">Single</option> <option value="ep">EP</option> <option value="album">Album</option> </select> </div> <div> <label class="block text-secondary mb-2">Title</label> <input type="text" id="projectTitleInput" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-1 ring-accent-primary" placeholder="Awesome Project"> </div> <div id="songTitlesSection" class="hidden space-y-2"> <label class="block text-secondary mb-1">Song Titles:</label> <div id="songTitlesList" class="max-h-48 overflow-y-auto pr-2"></div> </div> <div> <label class="block text-secondary mb-2">Genre</label> <select id="projectGenreSelect" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-1 ring-accent-primary"> <option value="primary">Primary</option> <option value="secondary">Secondary</option> <option value="experimental">Experimental</option> </select> </div> <div> <label class="block text-secondary mb-2">Style</label> <select id="projectStyleSelect" class="w-full bg-tertiary border border-main rounded-lg px-4 py-2 focus:outline-none focus:ring-1 ring-accent-primary"> <option value="current">Current</option> <option value="new">New Direction</option> <option value="collab">Collab</option> </select> </div> <div class="pt-4"> <button id="confirmProjectBtn" class="w-full button-primary font-bold py-2 px-4 rounded-lg"> Start Project </button> </div> </div> </div> </div>

        <!-- Release Modal -->
        <div id="releaseModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4"> <div class="bg-secondary rounded-xl p-6 w-full max-w-2xl"> <div class="text-center"> <h3 class="text-2xl font-bold text-accent-primary mb-2">Complete!</h3> <p class="text-secondary mb-6"><span id="completedProjectTitle" class="font-semibold text-primary"></span> is ready!</p> <div class="bg-tertiary rounded-lg p-6 mb-6"> <div class="flex justify-center mb-4"> <img id="releaseCoverArt" src="" class="cover-preview bg-gray-600"> </div> <h4 id="releaseTitle" class="font-bold text-lg"></h4> <p id="releaseType" class="text-muted text-sm mb-4"></p> <div class="grid grid-cols-3 gap-4 mt-6"> <div class="bg-gray-600 rounded-lg p-3"> <p class="text-muted text-xs">Buzz</p> <p id="initialBuzz" class="font-bold">...</p> </div> <div class="bg-gray-600 rounded-lg p-3"> <p class="text-muted text-xs">Reach</p> <p id="potentialReach" class="font-bold">...</p> </div> <div class="bg-gray-600 rounded-lg p-3"> <p class="text-muted text-xs">Industry</p> <p id="industryInterest" class="font-bold">...</p> </div> </div> </div> <button id="confirmReleaseBtn" class="button-primary font-bold py-2 px-6 rounded-full"> Release </button> <button id="cancelReleaseBtn" class="ml-4 button-secondary font-bold py-2 px-6 rounded-full"> Hold Off </button> </div> </div> </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] hidden p-4"> <div class="bg-secondary rounded-xl p-6 w-full max-w-md"> <div class="flex justify-between items-center mb-6"> <h3 class="text-xl font-bold text-accent-primary">Settings</h3> <button id="closeSettingsModalBtn" class="text-muted hover:text-primary"> <i class="fas fa-times"></i> </button> </div> <div class="space-y-6"> <div> <h4 class="font-semibold text-lg mb-3 text-accent-secondary">Theme</h4> <div class="grid grid-cols-2 gap-x-4 gap-y-3"> <div class="flex items-center justify-between"> <label for="bgColorPrimary" class="text-sm text-secondary">BG 1</label> <input type="color" id="bgColorPrimary" class="h-8 w-8 rounded border border-main cursor-pointer p-0"> </div> <div class="flex items-center justify-between"> <label for="bgColorSecondary" class="text-sm text-secondary">BG 2</label> <input type="color" id="bgColorSecondary" class="h-8 w-8 rounded border border-main cursor-pointer p-0"> </div> <div class="flex items-center justify-between"> <label for="textColorPrimary" class="text-sm text-secondary">Text</label> <input type="color" id="textColorPrimary" class="h-8 w-8 rounded border border-main cursor-pointer p-0"> </div> <div class="flex items-center justify-between"> <label for="accentColorPrimary" class="text-sm text-secondary">Accent</label> <input type="color" id="accentColorPrimary" class="h-8 w-8 rounded border border-main cursor-pointer p-0"> </div> <div class="flex items-center justify-between"> <label for="buttonBgColor" class="text-sm text-secondary">Button</label> <input type="color" id="buttonBgColor" class="h-8 w-8 rounded border border-main cursor-pointer p-0"> </div> <div class="flex items-center justify-between"> <label for="progressBarColor" class="text-sm text-secondary">Progress</label> <input type="color" id="progressBarColor" class="h-8 w-8 rounded border border-main cursor-pointer p-0"> </div> </div> <button id="resetThemeBtn" class="mt-4 w-full button-secondary text-xs py-1 rounded">Reset Theme</button> </div> <div> <h4 class="font-semibold text-lg mb-3 text-accent-secondary">Game Data</h4> <button id="resetProgressBtn" class="w-full button-danger font-bold py-2 px-4 rounded-lg text-sm"> Reset All Progress </button> <p class="text-xs text-muted mt-2 text-center">Warning: Cannot be undone!</p> </div> </div> </div> </div>

        <!-- Offline Progress Modal -->
        <div id="offlineProgressModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[70] hidden p-4"> <div class="bg-secondary rounded-xl p-8 w-full max-w-lg text-center shadow-xl"> <span class="text-4xl mb-4 block">ðŸš€</span> <h3 class="text-2xl font-bold text-accent-primary mb-3">Welcome Back!</h3> <p class="text-secondary mb-6">While away (<span id="offlineDuration"></span>)...</p> <div class="space-y-3 text-left bg-tertiary p-4 rounded-lg mb-6"> <p><i class="fas fa-headphones mr-2 text-blue-400"></i> Streams: <strong id="offlineStreams" class="text-primary">0</strong></p> <p><i class="fas fa-users mr-2 text-green-400"></i> Subs: <strong id="offlineSubscribers" class="text-primary">0</strong></p> <p><i class="fas fa-dollar-sign mr-2 text-yellow-400"></i> Income: <strong id="offlineIncome" class="text-primary">$0</strong></p> </div> <button id="closeOfflineModalBtn" class="button-primary font-bold py-2 px-6 rounded-full">Continue</button> </div> </div>

        <!-- Real-Time Stats Panel -->
        <div id="realTimeStatsPanel" class="fixed bottom-0 left-0 right-0 bg-secondary border-t border-main p-3 shadow-lg z-40 hidden"> <div class="container mx-auto"> <h3 class="font-semibold text-center text-accent-primary text-sm mb-2">Performance</h3> <div class="flex flex-wrap justify-around items-center text-center"> <div class="mx-2 my-1"> <p class="text-xs text-muted">Streams</p> <p id="rtStreams" class="font-bold text-sm number-ticker">0</p> </div> <div class="mx-2 my-1"> <p class="text-xs text-muted">Listeners</p> <p id="rtListeners" class="font-bold text-sm number-ticker">0</p> </div> <div class="mx-2 my-1"> <p class="text-xs text-muted">Subs</p> <p id="rtSubscribers" class="font-bold text-sm number-ticker">0</p> </div> <div class="mx-2 my-1"> <p class="text-xs text-muted">Income</p> <p id="rtIncome" class="font-bold text-sm number-ticker">$0</p> </div> <div class="mx-2 my-1"> <p class="text-xs text-muted">Growth</p> <p id="rtGrowthRate" class="font-bold text-sm number-ticker">Low</p> </div> </div> </div> </div>
    </div>

    <script>
        // --- Constants ---
        const DEFAULT_AVATAR = 'https://via.placeholder.com/100?text=Avatar';
        const DEFAULT_COVER_ART = 'https://via.placeholder.com/80?text=Art';
        const PLACEHOLDER_AVATAR_MALE = 'https://randomuser.me/api/portraits/lego/1.jpg';
        const PLACEHOLDER_AVATAR_FEMALE = 'https://randomuser.me/api/portraits/lego/5.jpg';
        const SIMULATION_INTERVAL = 2000; // ms between live stat updates
        const SOCIAL_UPDATE_INTERVAL = 5000; // ms between social feed updates
        const SAVE_INTERVAL = 15000; // ms between auto-saves
        const MAX_NOTIFICATIONS = 20;
        const MAX_SOCIAL_POSTS = 30;
        const LOCAL_STORAGE_KEY = 'riseToStardomSaveData_v2.2'; // Incremented version
        const PROJECT_PROGRESS_MULTIPLIER = 10; // Faster project work
        const PROMOTION_COST_SOCIAL = 500;
        const PROMOTION_DURATION_SOCIAL = 60000; // 60 seconds
        const PROMOTION_BOOST_SOCIAL = 5; // 5x growth rate boost
        const EP_SONG_COUNT = 4;
        const ALBUM_SONG_COUNT = 10;

        // --- Fame Levels Definition (Defined EARLY) ---
        const fameLevels = {
            UNKNOWN: { name: 'Unknown', threshold: 0, level: 0 },
            UPCOMING: { name: 'Up-and-Coming', threshold: 100, level: 1 },
            LOCAL_CELEB: { name: 'Local Celebrity', threshold: 1000, level: 2 },
            RISING_STAR: { name: 'Rising Star', threshold: 10000, level: 3 },
            NATIONAL_FAME: { name: 'National Fame', threshold: 100000, level: 4 },
            GLOBAL_SUPERSTAR: { name: 'Global Superstar', threshold: 1000000, level: 5 },
        };

        // --- Default Theme ---
        const defaultTheme = {
            '--bg-primary': '#111827', '--bg-secondary': '#1f2937', '--bg-tertiary': '#374151',
            '--text-primary': '#f9fafb', '--text-secondary': '#d1d5db', '--text-muted': '#9ca3af',
            '--accent-primary': '#a855f7', '--accent-secondary': '#eab308', '--border-color': '#4b5563',
            '--button-primary-bg': '#a855f7', '--button-primary-hover-bg': '#9333ea',
            '--button-secondary-bg': '#374151', '--button-secondary-hover-bg': '#4b5563',
            '--danger-bg': '#dc2626', '--danger-hover-bg': '#b91c1c', '--progress-bar-bg': '#a855f7'
        };

        // --- Initial Game State Function ---
        function getDefaultGameState() {
            return {
                player: {
                    stageName: '', realName: '', age: 22, hometown: 'smallTown',
                    primaryGenre: 'pop', secondaryGenre: 'none', style: 'polished', talent: 'charisma',
                    avatar: DEFAULT_AVATAR,
                    skills: { vocal: 50, songwriting: 50, production: 30, stage: 40, charisma: 10, technical: 10, marketing: 5, networking: 5 },
                    wellbeing: { energy: 80, mentalHealth: 70, publicImage: 60 },
                    stats: { subscribers: 0, streams: 0, income: 0, fame: fameLevels.UNKNOWN.name, fameLevelNumeric: fameLevels.UNKNOWN.level },
                    catalogue: [], firstReleaseDone: false, overallQualityScore: 0
                },
                currentProject: null, pendingRelease: null,
                notifications: [], upcomingEvents: [], socialFeed: [],
                growthInterval: null, socialInterval: null, saveInterval: null,
                currentGrowthRate: 0.1, promotionBoost: 1, promotionEndTime: 0,
                activeListeners: 0, milestonesReached: [],
                lastSaveTimestamp: Date.now(),
                theme: { ...defaultTheme }
            };
        }
        let gameState = getDefaultGameState(); // Initialize state

        // --- DOM Elements (Cached) ---
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        const resetProgressBtn = document.getElementById('resetProgressBtn');
        const offlineProgressModal = document.getElementById('offlineProgressModal');
        const offlineDurationSpan = document.getElementById('offlineDuration');
        const offlineStreamsSpan = document.getElementById('offlineStreams');
        const offlineSubscribersSpan = document.getElementById('offlineSubscribers');
        const offlineIncomeSpan = document.getElementById('offlineIncome');
        const closeOfflineModalBtn = document.getElementById('closeOfflineModalBtn');
        const songTitlesSection = document.getElementById('songTitlesSection');
        const songTitlesList = document.getElementById('songTitlesList');
        const promoteSocialMediaBtn = document.getElementById('promoteSocialMediaBtn');
        const promoCostSocialSpan = document.getElementById('promoCostSocial');
        const customPostContent = document.getElementById('customPostContent');
        const characterCreation = document.getElementById('characterCreation');
        const mainGame = document.getElementById('mainGame');
        const startGameBtn = document.getElementById('startGameBtn');
        const avatarOptions = document.querySelectorAll('.avatar-option');
        const avatarUpload = document.getElementById('avatarUpload');
        const avatarPreview = document.getElementById('avatarPreview');
        const stageNameInput = document.getElementById('stageName');
        const realNameInput = document.getElementById('realName');
        const startingAgeSelect = document.getElementById('startingAge');
        const hometownSelect = document.getElementById('hometown');
        const primaryGenreSelect = document.getElementById('primaryGenre');
        const secondaryGenreSelect = document.getElementById('secondaryGenre');
        const startingStyleSelect = document.getElementById('startingStyle');
        const innateTalentSelect = document.getElementById('innateTalent');
        const playerAvatar = document.getElementById('playerAvatar');
        const playerStageName = document.getElementById('playerStageName');
        const playerGenre = document.getElementById('playerGenre');
        const subscriberCount = document.getElementById('subscriberCount');
        const streamCount = document.getElementById('streamCount');
        const incomeCount = document.getElementById('incomeCount');
        const fameLevel = document.getElementById('fameLevel');
        const vocalSkillBar = document.getElementById('vocalSkillBar'); const vocalSkillValue = document.getElementById('vocalSkillValue');
        const songwritingSkillBar = document.getElementById('songwritingSkillBar'); const songwritingSkillValue = document.getElementById('songwritingSkillValue');
        const productionSkillBar = document.getElementById('productionSkillBar'); const productionSkillValue = document.getElementById('productionSkillValue');
        const stageSkillBar = document.getElementById('stageSkillBar'); const stageSkillValue = document.getElementById('stageSkillValue');
        const energyBar = document.getElementById('energyBar'); const energyValue = document.getElementById('energyValue');
        const mentalHealthBar = document.getElementById('mentalHealthBar'); const mentalHealthValue = document.getElementById('mentalHealthValue');
        const publicImageBar = document.getElementById('publicImageBar'); const publicImageValue = document.getElementById('publicImageValue');
        const noProject = document.getElementById('noProject');
        const activeProject = document.getElementById('activeProject');
        const projectTitle = document.getElementById('projectTitle');
        const projectType = document.getElementById('projectType');
        const projectStage = document.getElementById('projectStage');
        const projectProgressBar = document.getElementById('projectProgressBar');
        const projectProgressText = document.getElementById('projectProgressText');
        const projectCoverPreview = document.getElementById('projectCoverPreview');
        const startProjectBtn = document.getElementById('startProjectBtn');
        const workOnProjectBtn = document.getElementById('workOnProjectBtn');
        const cancelProjectBtn = document.getElementById('cancelProjectBtn');
        const projectModal = document.getElementById('projectModal');
        const closeProjectModalBtn = document.getElementById('closeProjectModalBtn');
        const coverArtUpload = document.getElementById('coverArtUpload');
        const modalCoverPreview = document.getElementById('modalCoverPreview');
        const projectTypeSelect = document.getElementById('projectTypeSelect');
        const projectTitleInput = document.getElementById('projectTitleInput');
        const projectGenreSelect = document.getElementById('projectGenreSelect');
        const projectStyleSelect = document.getElementById('projectStyleSelect');
        const confirmProjectBtn = document.getElementById('confirmProjectBtn');
        const releaseModal = document.getElementById('releaseModal');
        const completedProjectTitle = document.getElementById('completedProjectTitle');
        const releaseCoverArt = document.getElementById('releaseCoverArt');
        const releaseTitle = document.getElementById('releaseTitle');
        const releaseType = document.getElementById('releaseType');
        const initialBuzz = document.getElementById('initialBuzz');
        const potentialReach = document.getElementById('potentialReach');
        const industryInterest = document.getElementById('industryInterest');
        const confirmReleaseBtn = document.getElementById('confirmReleaseBtn');
        const cancelReleaseBtn = document.getElementById('cancelReleaseBtn');
        const realTimeStatsPanel = document.getElementById('realTimeStatsPanel');
        const rtStreams = document.getElementById('rtStreams');
        const rtListeners = document.getElementById('rtListeners');
        const rtSubscribers = document.getElementById('rtSubscribers');
        const rtIncome = document.getElementById('rtIncome');
        const rtGrowthRate = document.getElementById('rtGrowthRate');
        const practiceVocalsBtn = document.getElementById('practiceVocalsBtn');
        const writeSongBtn = document.getElementById('writeSongBtn');
        const produceTrackBtn = document.getElementById('produceTrackBtn');
        const restBtn = document.getElementById('restBtn');
        const catalogueSection = document.getElementById('catalogueSection');
        const catalogueList = document.getElementById('catalogueList');
        const postUpdateBtn = document.getElementById('postUpdateBtn');
        const refreshFeedBtn = document.getElementById('refreshFeedBtn');
        const socialFeed = document.getElementById('socialFeed');
        const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
        const notificationsList = document.getElementById('notificationsList');
        const upcomingEvents = document.getElementById('upcomingEvents');
        // Theme Inputs
        const bgColorPrimaryInput = document.getElementById('bgColorPrimary');
        const bgColorSecondaryInput = document.getElementById('bgColorSecondary');
        const textColorPrimaryInput = document.getElementById('textColorPrimary');
        const accentColorPrimaryInput = document.getElementById('accentColorPrimary');
        const buttonBgColorInput = document.getElementById('buttonBgColor');
        const progressBarColorInput = document.getElementById('progressBarColor');
        const resetThemeBtn = document.getElementById('resetThemeBtn');


        // --- Utility Functions ---
        function handleFileUpload(event, previewElement, storageCallback) { if (!event.target.files || event.target.files.length === 0) { previewElement.src = previewElement === avatarPreview ? DEFAULT_AVATAR : DEFAULT_COVER_ART; if (storageCallback) storageCallback(null); return; } const file = event.target.files[0]; if (file && file.type.startsWith('image/')) { const reader = new FileReader(); reader.onload = (e) => { previewElement.src = e.target.result; if (storageCallback) storageCallback(e.target.result); }; reader.onerror = () => { addNotification("Error reading file.", "warning"); event.target.value = null; previewElement.src = previewElement === avatarPreview ? DEFAULT_AVATAR : DEFAULT_COVER_ART; if (storageCallback) storageCallback(null); }; reader.readAsDataURL(file); } else { addNotification("Invalid file type.", "warning"); event.target.value = null; previewElement.src = previewElement === avatarPreview ? DEFAULT_AVATAR : DEFAULT_COVER_ART; if (storageCallback) storageCallback(null); } }
        function handleAvatarUpload(event) { handleFileUpload(event, avatarPreview, (imageDataUrl) => { gameState.player.avatar = imageDataUrl || DEFAULT_AVATAR; if (imageDataUrl) { avatarOptions.forEach(opt => opt.classList.remove('border-accent-primary')); } }); }
        function handleCoverArtUpload(event) { handleFileUpload(event, modalCoverPreview); }
        function selectDefaultAvatar(option) { avatarOptions.forEach(opt => opt.classList.remove('border-accent-primary')); option.classList.add('border-accent-primary'); const url = option.dataset.avatarUrl; gameState.player.avatar = url; avatarPreview.src = url; avatarUpload.value = null; }
        function formatNumber(num, isCurrency = false) { if (num === null || num === undefined || isNaN(num)) { return isCurrency ? '$NaN' : 'NaN'; } const roundedNum = Math.round(num); if (isNaN(roundedNum)) return isCurrency ? '$NaN' : 'NaN'; let formatted = roundedNum.toString(); if (!isCurrency) { if (roundedNum >= 1000000) formatted = (roundedNum / 1000000).toFixed(1).replace('.0', '') + 'M'; else if (roundedNum >= 10000) formatted = (roundedNum / 1000).toFixed(1).replace('.0', '') + 'K'; } try { return isCurrency ? '$' + roundedNum.toLocaleString() : formatted; } catch (e) { return isCurrency ? '$' + roundedNum : formatted; } }
        function capitalizeFirstLetter(string) { return typeof string === 'string' && string.length > 0 ? string.charAt(0).toUpperCase() + string.slice(1) : ''; }
        function formatDuration(milliseconds) { if (isNaN(milliseconds) || milliseconds < 0) return "a moment"; const seconds = Math.floor(milliseconds / 1000); const minutes = Math.floor(seconds / 60); const hours = Math.floor(minutes / 60); const days = Math.floor(hours / 24); if (days > 0) return `${days} day${days > 1 ? 's' : ''}`; if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''}`; if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''}`; return `${seconds} second${seconds !== 1 ? 's' : ''}`; }


        // --- Theme Functions ---
        function applyTheme(theme) {
             const root = document.documentElement;
             const themeToApply = theme && typeof theme === 'object' ? theme : defaultTheme;
             for (const [key, value] of Object.entries(themeToApply)) {
                 if (key.startsWith('--') && value) { root.style.setProperty(key, value); }
             }
             // Update color pickers only if they exist
             if (bgColorPrimaryInput) bgColorPrimaryInput.value = themeToApply['--bg-primary'];
             if (bgColorSecondaryInput) bgColorSecondaryInput.value = themeToApply['--bg-secondary'];
             if (textColorPrimaryInput) textColorPrimaryInput.value = themeToApply['--text-primary'];
             if (accentColorPrimaryInput) accentColorPrimaryInput.value = themeToApply['--accent-primary'];
             if (buttonBgColorInput) buttonBgColorInput.value = themeToApply['--button-primary-bg'];
             if (progressBarColorInput) progressBarColorInput.value = themeToApply['--progress-bar-bg'];
        }

        function updateThemeColor(variable, value) {
             if (!gameState.theme) gameState.theme = { ...defaultTheme };
             if (gameState.theme[variable] !== value) {
                 gameState.theme[variable] = value;
                 document.documentElement.style.setProperty(variable, value);
                 saveGame();
             }
        }

        function resetTheme() {
             gameState.theme = { ...defaultTheme };
             applyTheme(gameState.theme);
             saveGame();
             addNotification("Theme reset to default.", "info");
        }

        function setupThemePickers() {
             if (!settingsModal) return;
             bgColorPrimaryInput?.addEventListener('input', (e) => updateThemeColor('--bg-primary', e.target.value));
             bgColorSecondaryInput?.addEventListener('input', (e) => updateThemeColor('--bg-secondary', e.target.value));
             textColorPrimaryInput?.addEventListener('input', (e) => updateThemeColor('--text-primary', e.target.value));
             accentColorPrimaryInput?.addEventListener('input', (e) => updateThemeColor('--accent-primary', e.target.value));
             buttonBgColorInput?.addEventListener('input', (e) => updateThemeColor('--button-primary-bg', e.target.value));
             progressBarColorInput?.addEventListener('input', (e) => updateThemeColor('--progress-bar-bg', e.target.value));
             resetThemeBtn?.addEventListener('click', resetTheme);
        }

        // --- Save/Load/Reset Functions ---
        function saveGame() {
            try {
                gameState.lastSaveTimestamp = Date.now();
                const stateToSave = { ...gameState, growthInterval: null, socialInterval: null, saveInterval: null };
                const serializedState = JSON.stringify(stateToSave);
                localStorage.setItem(LOCAL_STORAGE_KEY, serializedState);
                 // console.log(`Game saved at ${new Date(gameState.lastSaveTimestamp).toLocaleTimeString()}`);
            } catch (error) { console.error("Save Error:", error); addNotification("Failed to save game.", "warning"); }
        }

        function loadGame() {
            try {
                const serializedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (serializedState) {
                    const loadedData = JSON.parse(serializedState);
                    gameState = deepMerge(getDefaultGameState(), loadedData); // Deep merge
                    gameState.growthInterval = null; gameState.socialInterval = null; gameState.saveInterval = null; // Ensure intervals cleared
                    applyTheme(gameState.theme || defaultTheme); // Apply theme
                    console.log("Game loaded.");
                    calculateOfflineProgress(); // Calc offline AFTER loading
                    return true;
                }
            } catch (error) { console.error("Load Error:", error); addNotification("Load failed. Starting fresh.", "warning"); resetGameData(); }
             applyTheme(defaultTheme); // Apply default if load fails
            return false;
        }

        function deepMerge(target, source) {
            for (const key in source) {
                if (source.hasOwnProperty(key)) {
                    const targetValue = target[key];
                    const sourceValue = source[key];
                    if (sourceValue !== null && typeof sourceValue === 'object' && !Array.isArray(sourceValue) && targetValue !== null && typeof targetValue === 'object' && !Array.isArray(targetValue)) {
                        deepMerge(targetValue, sourceValue);
                    } else if (sourceValue !== undefined) {
                        target[key] = sourceValue;
                    }
                }
            }
            return target;
         }

        function resetGameData() { stopIntervals(); gameState = getDefaultGameState(); localStorage.removeItem(LOCAL_STORAGE_KEY); applyTheme(defaultTheme); console.log("Game data reset."); }
        function resetGame() { if (confirm("Reset all progress? Cannot be undone.")) { resetGameData(); mainGame.classList.add('hidden'); realTimeStatsPanel.classList.add('hidden'); characterCreation.classList.remove('hidden'); settingsModal?.classList.add('hidden'); notificationsList.innerHTML = ''; socialFeed.innerHTML = ''; upcomingEvents.innerHTML = ''; catalogueList.innerHTML = '<p class="text-muted italic">No releases yet.</p>'; stageNameInput.value = ''; realNameInput.value = ''; avatarPreview.src = DEFAULT_AVATAR; avatarUpload.value = null; avatarOptions.forEach(opt => opt.classList.remove('border-accent-primary')); startingAgeSelect.value = '22'; primaryGenreSelect.value = 'pop'; secondaryGenreSelect.value = 'none'; startingStyleSelect.value = 'polished'; innateTalentSelect.value = 'charisma'; } }
        function calculateOfflineProgress() { const now = Date.now(); const lastSave = gameState.lastSaveTimestamp || now; const offlineMillis = Math.max(0, now - lastSave); if (offlineMillis < 30000) { return; } const offlineSeconds = offlineMillis / 1000; const effectiveGrowthRate = (gameState.currentGrowthRate || 0.1) * (gameState.promotionBoost || 1); const qualityFactor = Math.max(0.1, (gameState.player.overallQualityScore || 10) / 50); const subFactor = 1 + ((gameState.player.stats.subscribers || 0) / 10000); const listenerFactor = Math.max(1, (gameState.activeListeners || 0) * 0.1); const avgStreamsPerSecond = effectiveGrowthRate * listenerFactor * subFactor * (15 * randomFluctuation()); const avgSubsPerSecond = effectiveGrowthRate * subFactor * qualityFactor * (0.015 * randomFluctuation()); const avgIncomePerSecond = avgStreamsPerSecond * 0.0015; const streamsGained = Math.round(avgStreamsPerSecond * offlineSeconds); const subsGained = Math.round(avgSubsPerSecond * offlineSeconds); const incomeGained = avgIncomePerSecond * offlineSeconds; if (streamsGained > 0 || subsGained > 0 || incomeGained > 0.01) { gameState.player.stats.streams = (gameState.player.stats.streams || 0) + streamsGained; gameState.player.stats.subscribers = Math.max(0, (gameState.player.stats.subscribers || 0) + subsGained); gameState.player.stats.income = (gameState.player.stats.income || 0) + incomeGained; addNotification(`Welcome back! Gained ${formatNumber(streamsGained)} streams, ${formatNumber(subsGained)} subs, ${formatNumber(incomeGained, true)}.`, 'info'); offlineDurationSpan.textContent = formatDuration(offlineMillis); offlineStreamsSpan.textContent = formatNumber(streamsGained); offlineSubscribersSpan.textContent = formatNumber(subsGained); offlineIncomeSpan.textContent = formatNumber(incomeGained, true); offlineProgressModal?.classList.remove('hidden'); } gameState.lastSaveTimestamp = now; }
        function randomFluctuation() { return 0.8 + Math.random() * 0.4; } // Keep helper


        // --- Core Game Logic ---
        function startGame() {
             stopIntervals();
             if (!loadGame()) { resetGameData(); console.log("Starting new game."); applyTheme(defaultTheme); }
             else { console.log("Loaded game state."); characterCreation.classList.add('hidden'); mainGame.classList.remove('hidden'); if (gameState.player.firstReleaseDone) realTimeStatsPanel.classList.remove('hidden'); startIntervals(); updateAllUI(); return; }
             // --- New Game Setup ---
             gameState.player.stageName = stageNameInput.value.trim() || 'Unknown Artist';
             gameState.player.realName = realNameInput.value.trim() || '';
             gameState.player.age = parseInt(startingAgeSelect.value);
             gameState.player.hometown = hometownSelect.value;
             gameState.player.primaryGenre = primaryGenreSelect.value;
             gameState.player.secondaryGenre = secondaryGenreSelect.value;
             gameState.player.style = startingStyleSelect.value;
             gameState.player.talent = innateTalentSelect.value;
             if (!gameState.player.avatar || gameState.player.avatar === DEFAULT_AVATAR) { const selectedDefault = document.querySelector('.avatar-option.border-accent-primary'); gameState.player.avatar = selectedDefault ? selectedDefault.dataset.avatarUrl : PLACEHOLDER_AVATAR_MALE; }
             applyTalentBonus(); clampSkillsAndWellbeing();
             // Init UI
             characterCreation.classList.add('hidden'); mainGame.classList.remove('hidden'); realTimeStatsPanel.classList.add('hidden');
             playerAvatar.src = gameState.player.avatar; playerStageName.textContent = gameState.player.stageName; playerGenre.textContent = `${capitalizeFirstLetter(gameState.player.primaryGenre)} Artist`;
             // Init data
             gameState.notifications = [ { id: Date.now(), message: `Welcome ${gameState.player.stageName}!`, timestamp: 'Just now', type: 'info' } ];
             gameState.upcomingEvents = [ { id: 1, title: 'Debut Release', description: 'Complete your first song', icon: 'calendar-day' } ];
             gameState.socialFeed = [ { id: Date.now()+1, user: 'MusicFan92', avatar: PLACEHOLDER_AVATAR_FEMALE, time: 'Few hours ago', content: 'Looking for new artists!', likes: 12, comments: 3 }, { id: Date.now()+2, user: 'IndustryInsider', avatar: PLACEHOLDER_AVATAR_MALE, time: 'Earlier', content: 'Who\'s making waves?', likes: 45, comments: 8 } ];
             gameState.milestonesReached = [];
             startIntervals(); updateAllUI(); renderCatalogue(); saveGame();
        }

        function applyTalentBonus() {
             const applyBonus = (skill, bonus) => { gameState.player.skills[skill] = (gameState.player.skills[skill] || 0) + bonus; };
             const talent = gameState.player.talent;
             if (talent === 'charisma') { applyBonus('charisma', 15); applyBonus('stage', 5); gameState.player.wellbeing.publicImage = (gameState.player.wellbeing.publicImage || 0) + 5;}
             else if (talent === 'prodigy') { applyBonus('vocal', 10); applyBonus('songwriting', 10); applyBonus('production', 5);}
             else if (talent === 'technical') { applyBonus('technical', 15); applyBonus('production', 10);}
             else if (talent === 'lyricism') { applyBonus('songwriting', 15); }
             else if (talent === 'stage') { applyBonus('stage', 15); applyBonus('charisma', 5);}
        }
        function clampSkillsAndWellbeing() { for (const skill in gameState.player.skills) { gameState.player.skills[skill] = Math.min(100, Math.max(0, Math.round(gameState.player.skills[skill] || 0))); } for (const key in gameState.player.wellbeing) { gameState.player.wellbeing[key] = Math.min(100, Math.max(0, Math.round(gameState.player.wellbeing[key] || 0))); } }
        function openProjectModal() { if (gameState.currentProject) { addNotification("Finish current project!", "warning"); return; } projectTitleInput.value = ''; modalCoverPreview.src = DEFAULT_COVER_ART; coverArtUpload.value = null; projectTypeSelect.value = 'single'; updateSongTitlesUI('single'); projectModal.classList.remove('hidden'); }
        function closeProjectModal() { projectModal.classList.add('hidden'); }
        function updateSongTitlesUI(projectType) { songTitlesList.innerHTML = ''; let numSongs = 0; if (projectType === 'ep') numSongs = EP_SONG_COUNT; else if (projectType === 'album') numSongs = ALBUM_SONG_COUNT; if (numSongs > 0) { songTitlesSection.classList.remove('hidden'); for (let i = 0; i < numSongs; i++) { const input = document.createElement('input'); input.type = 'text'; input.placeholder = `Song ${i + 1} Title`; input.className = 'w-full bg-tertiary border border-main rounded-lg px-3 py-1.5 text-sm mb-2 focus:outline-none focus:ring-1 ring-accent-primary song-title-input'; songTitlesList.appendChild(input); } } else { songTitlesSection.classList.add('hidden'); } }
        function createProject() { if (gameState.currentProject) { addNotification("Finish current project!", "warning"); return; } const type = projectTypeSelect.value; const title = projectTitleInput.value.trim() || `Untitled ${capitalizeFirstLetter(type)}`; const genre = projectGenreSelect.value; const style = projectStyleSelect.value; const coverArt = modalCoverPreview.src; let songs = []; if (type === 'ep' || type === 'album') { const titleInputs = songTitlesList.querySelectorAll('.song-title-input'); titleInputs.forEach((input, index) => { songs.push({ title: input.value.trim() || `Track ${index + 1}`, streams: 0 }); }); } gameState.currentProject = { id: Date.now(), type, title, genre, style, coverArt, progress: 0, quality: 0, stages: ['Writing', 'Recording', 'Production', 'Mixing', 'Mastering'], currentStageIndex: 0, songs }; updateProjectUI(); closeProjectModal(); addNotification(`Started: ${title}`); saveGame(); }

        function workOnProject() {
            if (!gameState.currentProject) { return; }
            if ((gameState.player.wellbeing.energy || 0) < 5) { addNotification('Too exhausted!', 'warning'); return; }

            const projectTitleForNotification = gameState.currentProject.title;
            const currentEnergy = gameState.player.wellbeing.energy || 0;
            const currentProgress = gameState.currentProject.progress || 0;
            const currentQuality = gameState.currentProject.quality || 0;

            let primarySkillName, secondarySkillName;
            const stageIndex = gameState.currentProject.currentStageIndex || 0;
            const stage = gameState.currentProject.stages?.[stageIndex] || 'Writing'; // Fallback stage
            switch(stage) { case 'Writing': primarySkillName = 'songwriting'; secondarySkillName = 'vocal'; break; case 'Recording': primarySkillName = 'vocal'; secondarySkillName = 'stage'; break; case 'Production': primarySkillName = 'production'; secondarySkillName = 'technical'; break; case 'Mixing': primarySkillName = 'production'; secondarySkillName = 'technical'; break; case 'Mastering': primarySkillName = 'technical'; secondarySkillName = 'production'; break; default: primarySkillName = 'songwriting'; secondarySkillName = 'production'; }
            const primarySkillValue = gameState.player.skills?.[primarySkillName] || 0;
            const secondarySkillValue = gameState.player.skills?.[secondarySkillName] || 0;
            if (isNaN(primarySkillValue) || isNaN(secondarySkillValue) || isNaN(currentEnergy)) { console.error("Invalid inputs for work calc."); return; }

            const skillFactor = (primarySkillValue * 0.7 + secondarySkillValue * 0.3) / 100;
            const energyFactor = Math.max(0.1, currentEnergy / 100);
            const randomFactor = randomFluctuation();
            const progressIncreaseRaw = (5 + Math.random() * 10) * skillFactor * energyFactor * randomFactor * PROJECT_PROGRESS_MULTIPLIER;
            const qualityIncreaseRaw = (0.5 + Math.random() * 1) * skillFactor * energyFactor * randomFactor;
            const progressIncrease = isNaN(progressIncreaseRaw) ? 1 : Math.max(1, Math.round(progressIncreaseRaw));
            const qualityIncrease = isNaN(qualityIncreaseRaw) ? 0.1 : Math.max(0.1, qualityIncreaseRaw);
            if (isNaN(progressIncrease) || isNaN(qualityIncrease)) { console.error("NaN calc result in work."); return; }

            const newProgress = Math.min(100, currentProgress + progressIncrease);
            const newQuality = currentQuality + qualityIncrease;
            if (isNaN(newProgress) || isNaN(newQuality)) { console.error("NaN state update in work."); return; }
            gameState.currentProject.progress = newProgress;
            gameState.currentProject.quality = newQuality;

            if (gameState.currentProject.progress < 100) addNotification(`Progress on ${projectTitleForNotification}`);

            const stages = gameState.currentProject.stages || [];
            const stageThreshold = stages.length > 0 ? 100 / stages.length : 100;
            if (newProgress >= (stageIndex + 1) * stageThreshold && stageIndex < stages.length - 1) {
                gameState.currentProject.currentStageIndex++;
                if (gameState.currentProject.currentStageIndex < stages.length) addNotification(`"${projectTitleForNotification}" -> ${stages[gameState.currentProject.currentStageIndex]} stage.`);
            }

            if (gameState.currentProject.progress >= 100) {
                const avgProgress = progressIncrease > 0 ? progressIncrease : 5;
                const estimatedWorkSessions = Math.max(1, 100 / avgProgress);
                const finalQuality = Math.min(100, Math.round((gameState.currentProject.quality || 0) / estimatedWorkSessions * 20));
                gameState.currentProject.quality = isNaN(finalQuality) ? 50 : finalQuality;
                prepareRelease();
            } else { updateProjectUI(); }

            const energyCost = Math.round(5 + Math.random() * 5);
            gameState.player.wellbeing.energy = Math.max(0, Math.round(currentEnergy - energyCost));
            if (Math.random() < 0.1) { const mentalCost = Math.round(1 + Math.random() * 2); gameState.player.wellbeing.mentalHealth = Math.max(0, Math.round((gameState.player.wellbeing.mentalHealth || 0) - mentalCost)); }
            const improveSkill = (skillName) => { if (skillName && typeof gameState.player.skills?.[skillName] === 'number') { const gain = Math.round(0.5 + Math.random()); gameState.player.skills[skillName] = Math.min(100, Math.round(gameState.player.skills[skillName] + gain)); } };
            if (Math.random() < 0.15) improveSkill(primarySkillName);
            if (Math.random() < 0.10) improveSkill(secondarySkillName);
            updateWellbeingBars(); updateSkillBars();
        }

        function cancelProject() { if (!gameState.currentProject) return; if (confirm(`Cancel "${gameState.currentProject.title}"?`)) { addNotification(`Canceled: ${gameState.currentProject.title}`); gameState.currentProject = null; updateProjectUI(); saveGame(); } }
        function prepareRelease() { if (!gameState.currentProject || gameState.currentProject.progress < 100) return; gameState.pendingRelease = { ...gameState.currentProject }; gameState.currentProject = null; updateProjectUI(); const finalQuality = Math.round(gameState.pendingRelease.quality || 50); gameState.pendingRelease.quality = isNaN(finalQuality) ? 50 : finalQuality; completedProjectTitle.textContent = gameState.pendingRelease.title; releaseCoverArt.src = gameState.pendingRelease.coverArt || DEFAULT_COVER_ART; releaseTitle.textContent = gameState.pendingRelease.title; releaseType.textContent = capitalizeFirstLetter(gameState.pendingRelease.type); const qualityScore = gameState.pendingRelease.quality; const fameFactor = (gameState.player.stats.fameLevelNumeric || 0) * 0.1 + 1; const hypeFactor = ((gameState.player.wellbeing.publicImage || 0) / 100) * 0.5 + 0.5; const subFactor = Math.log10(Math.max(10, gameState.player.stats.subscribers || 0)) / 2; const calculateScore = (baseCalculation) => { const score = Math.round(baseCalculation * randomFluctuation() * fameFactor * subFactor * hypeFactor); return Math.min(100, Math.max(0, isNaN(score) ? 0 : score)); }; const skillStage = gameState.player.skills.stage || 0; const skillCharisma = gameState.player.skills.charisma || 0; const skillProd = gameState.player.skills.production || 0; const skillMarket = gameState.player.skills.marketing || 0; const skillWrite = gameState.player.skills.songwriting || 0; const skillNetwork = gameState.player.skills.networking || 0; const buzzScore = calculateScore(qualityScore * 0.5 + skillStage * 0.2 + skillCharisma * 0.1); const reachScore = calculateScore(qualityScore * 0.6 + skillProd * 0.1 + skillMarket * 0.1); const interestScore = calculateScore(qualityScore * 0.4 + skillWrite * 0.3 + skillNetwork * 0.1); initialBuzz.textContent = getMetricDescription(buzzScore); potentialReach.textContent = getMetricDescription(reachScore); industryInterest.textContent = getMetricDescription(interestScore); gameState.pendingRelease.buzzScore = buzzScore; gameState.pendingRelease.reachScore = reachScore; gameState.pendingRelease.interestScore = interestScore; releaseModal.classList.remove('hidden'); }
        function getMetricDescription(score) { const roundedScore = Math.round(score || 0); if (roundedScore < 20) return 'Minimal'; if (roundedScore < 40) return 'Low'; if (roundedScore < 60) return 'Moderate'; if (roundedScore < 80) return 'High'; return 'Exceptional'; }

        function releaseProject() {
             if (!gameState.pendingRelease) return;
             releaseModal.classList.add('hidden');
             const releasedProject = { ...gameState.pendingRelease };
             gameState.pendingRelease = null;

             releasedProject.quality = Math.round(releasedProject.quality || 50);
             releasedProject.streams = 0;
             if ((releasedProject.type === 'ep' || releasedProject.type === 'album') && !Array.isArray(releasedProject.songs)) releasedProject.songs = [];
             if (Array.isArray(releasedProject.songs)) { releasedProject.songs.forEach(song => { if (song.streams === undefined) song.streams = 0; }); }
             gameState.player.catalogue.push(releasedProject);

             const quality = releasedProject.quality || 0;
             const reach = releasedProject.reachScore || 0;
             const buzz = releasedProject.buzzScore || 0;
             const fameLevel = gameState.player.stats.fameLevelNumeric || 0;
             const baseImpact = quality * (reach + buzz) / 200;
             const initialStreamsRaw = baseImpact * (100 + Math.random() * 150) * (1 + fameLevel * 0.1);
             const initialSubscribersRaw = baseImpact * (buzz / 5) * (0.5 + Math.random() * 0.5) * (quality/50) * (1 + fameLevel * 0.1);
             const initialIncomeRaw = (isNaN(initialStreamsRaw) ? 0 : initialStreamsRaw) * (0.001 + Math.random() * 0.001);
             const initialStreams = isNaN(initialStreamsRaw) ? 0 : Math.round(initialStreamsRaw);
             const initialSubscribers = isNaN(initialSubscribersRaw) ? 0 : Math.round(initialSubscribersRaw);
             const initialIncome = isNaN(initialIncomeRaw) ? 0 : initialIncomeRaw;
             const initialListeners = Math.round(initialStreams * (0.05 + Math.random()*0.1));

             const catalogueEntry = gameState.player.catalogue.find(p => p.id === releasedProject.id);
             if(catalogueEntry) {
                 catalogueEntry.streams = (catalogueEntry.streams || 0) + initialStreams;
                 if ((catalogueEntry.type === 'ep' || catalogueEntry.type === 'album') && Array.isArray(catalogueEntry.songs) && catalogueEntry.songs.length > 0) {
                     const streamsPerSong = initialStreams > 0 ? Math.max(0, Math.round(initialStreams / catalogueEntry.songs.length)) : 0; // Ensure non-negative
                     let assignedStreams = 0;
                     catalogueEntry.songs.forEach((song, index) => {
                          const songStreams = (index === catalogueEntry.songs.length - 1) ? Math.max(0, initialStreams - assignedStreams) : streamsPerSong; // Ensure non-negative & total matches
                          song.streams = (song.streams || 0) + songStreams;
                          assignedStreams += songStreams;
                     });
                     catalogueEntry.streams = catalogueEntry.songs.reduce((sum, song) => sum + (song.streams || 0), 0);
                  }
             }

             gameState.player.stats.streams = (gameState.player.stats.streams || 0) + initialStreams;
             gameState.player.stats.subscribers = Math.max(0, (gameState.player.stats.subscribers || 0) + initialSubscribers);
             gameState.player.stats.income = (gameState.player.stats.income || 0) + initialIncome;
             gameState.activeListeners = (gameState.activeListeners || 0) + initialListeners;

             const totalQuality = gameState.player.catalogue.reduce((sum, item) => sum + (item.quality || 0), 0);
             gameState.player.overallQualityScore = gameState.player.catalogue.length > 0 ? Math.round(totalQuality / gameState.player.catalogue.length) : 0;

             const qualityImpact = Math.max(0.5, (releasedProject.quality / 50));
             const catalogueBonus = 1 + (gameState.player.catalogue.length / 20);
             const fameBonus = 1 + (fameLevel / 10);
             const overallQualityFactor = Math.max(0.1, (gameState.player.overallQualityScore || 10) / 50);
             const newGrowthRate = overallQualityFactor * qualityImpact * catalogueBonus * fameBonus;
             gameState.currentGrowthRate = isNaN(newGrowthRate) ? 0.1 : Math.max(0.1, newGrowthRate);

             if (!gameState.player.firstReleaseDone) {
                 gameState.player.firstReleaseDone = true;
                 realTimeStatsPanel.classList.remove('hidden');
                 gameState.upcomingEvents = gameState.upcomingEvents.filter(e => e.id !== 1);
                 gameState.upcomingEvents.push({ id: Date.now(), title: 'Fan Reactions', description: `Response to ${releasedProject.title}`, icon: 'users' });
                 startIntervals();
             }

             const interestScore = releasedProject.interestScore || 0;
             if (interestScore > 70) addNotification("Industry taking notice!", "milestone");
             else if (interestScore > 50) addNotification("Generated industry buzz.", "info");

             addNotification(`${releasedProject.title} released! Gained ${formatNumber(initialStreams)} streams & ${formatNumber(initialSubscribers)} subs initially.`, 'success');
             renderCatalogue();
             updateAllUI();
             saveGame();
        }

        // --- Simulation Intervals ---
        function stopIntervals() { if (gameState.growthInterval) clearInterval(gameState.growthInterval); if (gameState.socialInterval) clearInterval(gameState.socialInterval); if (gameState.saveInterval) clearInterval(gameState.saveInterval); gameState.growthInterval = null; gameState.socialInterval = null; gameState.saveInterval = null; }
        function startIntervals() { stopIntervals(); gameState.growthInterval = setInterval(() => { if (!gameState.player.firstReleaseDone) return; if (gameState.promotionEndTime > 0 && Date.now() > gameState.promotionEndTime) { gameState.promotionBoost = 1; gameState.promotionEndTime = 0; addNotification("Promotion ended.", "info"); } const effectiveGrowthRate = (gameState.currentGrowthRate || 0.1) * (gameState.promotionBoost || 1); const listeners = gameState.activeListeners || 0; const subs = gameState.player.stats.subscribers || 0; const qualityScore = gameState.player.overallQualityScore || 10; if (isNaN(effectiveGrowthRate) || isNaN(listeners) || isNaN(subs) || isNaN(qualityScore)) { console.error("NaN inputs in growth interval"); return; } const baseGrowth = effectiveGrowthRate * Math.max(1, listeners * 0.1); const subBoost = 1 + (subs / 10000); const randFluct = randomFluctuation(); const newStreamsRaw = baseGrowth * (10 + Math.random() * 20) * subBoost * randFluct; const listenerGainRaw = baseGrowth * (0.5 + Math.random()) * subBoost * randFluct * (qualityScore/50); const listenerDecay = Math.round(listeners * (0.01 + Math.random() * 0.02)); const newListenersDeltaRaw = listenerGainRaw - listenerDecay; const newSubscribersRaw = baseGrowth * (0.01 + Math.random() * 0.02) * (qualityScore / 50) * randFluct * subBoost; const newIncomeRaw = (isNaN(newStreamsRaw) ? 0 : newStreamsRaw) * (0.001 + Math.random() * 0.001); const newStreams = isNaN(newStreamsRaw) ? 0 : Math.round(newStreamsRaw); const newListenersDelta = isNaN(newListenersDeltaRaw) ? 0 : Math.round(newListenersDeltaRaw); const newSubscribers = isNaN(newSubscribersRaw) ? 0 : Math.round(newSubscribersRaw); const newIncome = isNaN(newIncomeRaw) ? 0 : newIncomeRaw; if (isNaN(newStreams) || isNaN(newListenersDelta) || isNaN(newSubscribers) || isNaN(newIncome)) { console.error("NaN results in growth interval"); return; } if (gameState.player.catalogue.length > 0 && newStreams > 0) { const latestRelease = gameState.player.catalogue[gameState.player.catalogue.length - 1]; latestRelease.streams = (latestRelease.streams || 0) + newStreams; if ((latestRelease.type === 'ep' || latestRelease.type === 'album') && Array.isArray(latestRelease.songs) && latestRelease.songs.length > 0) { const streamsPerSong = newStreams > 0 ? Math.max(0,Math.round(newStreams / latestRelease.songs.length)) : 0; let assignedStreams = 0; latestRelease.songs.forEach((song, index) => { const songStreams = (index === latestRelease.songs.length - 1) ? Math.max(0, newStreams - assignedStreams) : streamsPerSong; song.streams = (song.streams || 0) + songStreams; assignedStreams += songStreams; }); latestRelease.streams = latestRelease.songs.reduce((sum, song) => sum + (song.streams || 0), 0); } } gameState.player.stats.streams = (gameState.player.stats.streams || 0) + newStreams; gameState.player.stats.subscribers = Math.max(0, (gameState.player.stats.subscribers || 0) + newSubscribers); gameState.player.stats.income = (gameState.player.stats.income || 0) + newIncome; gameState.activeListeners = Math.max(0, (gameState.activeListeners || 0) + newListenersDelta); updateStats(); updateRealTimeStats(); checkMilestones(); }, SIMULATION_INTERVAL); gameState.socialInterval = setInterval(() => { if (!gameState.player.firstReleaseDone || !Array.isArray(gameState.socialFeed)) return; if (Math.random() < 0.5 && gameState.socialFeed.length > 0) { const postIndex = Math.floor(Math.random() * gameState.socialFeed.length); const post = gameState.socialFeed[postIndex]; if (post) { if(Math.random() < 0.7) post.likes = (post.likes || 0) + Math.floor(Math.random() * 3) + 1; if(Math.random() < 0.3) post.comments = (post.comments || 0) + 1; renderSocialFeed(); } } if (Math.random() < 0.2) { generateNpcPost(); } }, SOCIAL_UPDATE_INTERVAL); gameState.saveInterval = setInterval(saveGame, SAVE_INTERVAL); console.log("Intervals started."); }

        // --- Gameplay Functions ---
        function updateRealTimeStats() { if (!gameState.player.firstReleaseDone) return; rtStreams.textContent = formatNumber(gameState.player.stats.streams); rtListeners.textContent = formatNumber(gameState.activeListeners); rtSubscribers.textContent = formatNumber(gameState.player.stats.subscribers); rtIncome.textContent = formatNumber(gameState.player.stats.income, true); let growthDesc; const rate = (gameState.currentGrowthRate || 0) * (gameState.promotionBoost || 1); if(rate < 0.5) growthDesc = 'Stagnant'; else if (rate < 1.5) growthDesc = 'Slow'; else if (rate < 3) growthDesc = 'Steady'; else if (rate < 5) growthDesc = 'Growing'; else growthDesc = 'Rapid'; if(gameState.promotionBoost > 1) growthDesc += " (Boost!)"; rtGrowthRate.textContent = growthDesc; }
        function updateFameLevel() { const subs = gameState.player.stats.subscribers || 0; let currentFame = fameLevels.UNKNOWN; let foundLevel = fameLevels.UNKNOWN; Object.values(fameLevels).sort((a, b) => a.threshold - b.threshold).forEach(level => { if (subs >= level.threshold) foundLevel = level; }); currentFame = foundLevel; if (gameState.player.stats.fame !== currentFame.name) { if (gameState.player.stats.fame !== fameLevels.UNKNOWN.name) addNotification(`Fame increased: ${currentFame.name}!`, 'milestone'); gameState.player.stats.fame = currentFame.name; gameState.player.stats.fameLevelNumeric = currentFame.level; if(fameLevel) fameLevel.textContent = currentFame.name; } if (typeof gameState.player.stats.fameLevelNumeric !== 'number') gameState.player.stats.fameLevelNumeric = currentFame.level; }
        function checkMilestones() { updateFameLevel(); const checkAndNotify = (key, threshold, message) => { const value = gameState.player.stats[key] || 0; const milestoneId = `${key}-${threshold}`; if (!gameState.milestonesReached.includes(milestoneId) && value >= threshold) { addNotification(message, "milestone"); gameState.milestonesReached.push(milestoneId); } }; checkAndNotify('streams', 1000, "1k+ streams!"); checkAndNotify('streams', 10000, "10k+ streams!"); checkAndNotify('streams', 100000, "100k+ streams!"); checkAndNotify('income', 1000, "Earned $1k+!"); checkAndNotify('income', 10000, "Earned $10k+!"); checkAndNotify('subscribers', 100, "100+ Subs!"); // Add sub milestone
        }
        function practiceSkill(skill) { const currentEnergy = gameState.player.wellbeing.energy || 0; if (currentEnergy < 10) { addNotification('Too tired!', 'warning'); return; } if (!gameState.player.skills || typeof gameState.player.skills[skill] !== 'number') { return; } const skillIncrease = Math.round(1 + Math.random() * 2); gameState.player.skills[skill] = Math.min(100, Math.round(gameState.player.skills[skill] + skillIncrease)); const energyCost = Math.round(8 + Math.random() * 4); gameState.player.wellbeing.energy = Math.max(0, Math.round(currentEnergy - energyCost)); if (Math.random() < 0.15) { const mentalCost = Math.round(1 + Math.random() * 2); gameState.player.wellbeing.mentalHealth = Math.max(0, Math.round((gameState.player.wellbeing.mentalHealth || 0) - mentalCost)); } updateSkillBars(); updateWellbeingBars(); addNotification(`${capitalizeFirstLetter(skill)} practiced!`); }
        function rest() { const energyGain = Math.round(20 + Math.random() * 15); const mentalGain = Math.round(10 + Math.random() * 10); gameState.player.wellbeing.energy = Math.min(100, Math.round((gameState.player.wellbeing.energy || 0) + energyGain)); gameState.player.wellbeing.mentalHealth = Math.min(100, Math.round((gameState.player.wellbeing.mentalHealth || 0) + mentalGain)); updateWellbeingBars(); addNotification('Rested.'); }
        function postUpdate() { const content = customPostContent.value.trim(); if (!content) { addNotification("Write something!", "warning"); return; } if (!gameState.player.stageName) return; addSocialFeedPost({ user: gameState.player.stageName, avatar: gameState.player.avatar, time: 'Just now', content: content, likes: 0, comments: 0, isPlayer: true }); customPostContent.value = ''; if (gameState.player.firstReleaseDone && Math.random() < 0.5) { const qualityFactor = Math.max(0.1, (gameState.player.overallQualityScore || 10) / 50); const fameFactor = 1 + (gameState.player.stats.fameLevelNumeric || 0); const newSubsRaw = (Math.random() * 3) * qualityFactor * fameFactor; const newSubs = isNaN(newSubsRaw) ? 0 : Math.max(0, Math.round(newSubsRaw)); if (newSubs > 0) { gameState.player.stats.subscribers = (gameState.player.stats.subscribers || 0) + newSubs; updateStats(); updateRealTimeStats(); addNotification(`Post gained ${newSubs} sub${newSubs !== 1 ? 's' : ''}!`, 'success'); } const imageGain = Math.random() * 3; gameState.player.wellbeing.publicImage = Math.min(100, Math.round((gameState.player.wellbeing.publicImage || 0) + imageGain)); updateWellbeingBars(); } saveGame(); }
        function generateNpcPost() { if (!Array.isArray(gameState.socialFeed)) return; const users = [ { name: 'MusicLover', avatar: PLACEHOLDER_AVATAR_FEMALE }, { name: 'IndieFan', avatar: PLACEHOLDER_AVATAR_MALE }, { name: 'PopEnthusiast', avatar: PLACEHOLDER_AVATAR_FEMALE }, { name: 'HipHopHead', avatar: PLACEHOLDER_AVATAR_MALE }, { name: 'CriticCorner', avatar: 'https://randomuser.me/api/portraits/men/75.jpg' }, { name: 'FanGirlXo', avatar: 'https://randomuser.me/api/portraits/women/75.jpg' } ]; const randomUser = users[Math.floor(Math.random() * users.length)]; const playerName = gameState.player.stageName || 'the new artist'; const qualityScore = gameState.player.overallQualityScore || 50; const fameLevel = gameState.player.stats.fameLevelNumeric || 0; let messages = [ `Heard ${playerName}'s track! Thoughts?`, "Looking for fresh sounds.", `Is ${playerName} overhyped? ðŸ¤”`, "Scene feels stale...", `Obsessed with ${playerName}? ðŸ˜`, `Top 5 this week...`, `Review: ${playerName}'s latest...`, `Beat is ðŸ”¥ #NowPlaying`, `${playerName} needs to tour! ðŸ™`, ]; if (qualityScore > 70 && fameLevel > 2) messages.push(`Wow, ${playerName} killing it! ðŸ”¥ #GOAT`); if (qualityScore < 40 && fameLevel > 1) messages.push(`Listened to ${playerName}... not my vibe. ðŸ˜¬`); const randomMessage = messages[Math.floor(Math.random() * messages.length)]; addSocialFeedPost({ user: randomUser.name, avatar: randomUser.avatar, time: 'A moment ago', content: randomMessage, likes: Math.floor(Math.random() * 20), comments: Math.floor(Math.random() * 5) }); }
        function refreshFeed() { const numToAdd = Math.floor(Math.random() * 3) + 1; for (let i = 0; i < numToAdd; i++) { generateNpcPost(); } addNotification('Feed updated'); }
        function addSocialFeedPost(postData) { if (!postData || !postData.user || !postData.content) return; gameState.socialFeed.unshift({ id: Date.now() + Math.random(), likes: postData.likes || 0, comments: postData.comments || 0, time: postData.time || 'Just now', ...postData }); while (gameState.socialFeed.length > MAX_SOCIAL_POSTS) { gameState.socialFeed.pop(); } renderSocialFeed(); }
        function addNotification(message, type = 'info') { if (!message) return; const timestamp = new Date(); const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); const notification = { id: Date.now() + Math.random(), message: message, type: type, timestamp: timeString }; gameState.notifications.unshift(notification); while (gameState.notifications.length > MAX_NOTIFICATIONS) { gameState.notifications.pop(); } renderNotifications(); showToast(message, type); }
        function showToast(message, type) { const toastContainer = document.body; if (!toastContainer) return; const toast = document.createElement('div'); toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white text-sm flex items-center z-[100] transition-opacity duration-300 ease-out opacity-0 ${type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-yellow-600' : type === 'milestone' ? 'bg-purple-600' : 'bg-blue-600'}`; let icon; switch(type) { case 'success': icon = 'check-circle'; break; case 'warning': icon = 'exclamation-triangle'; break; case 'milestone': icon = 'trophy'; break; default: icon = 'info-circle'; } toast.innerHTML = `<i class="fas fa-${icon} mr-2"></i><span>${message}</span>`; toastContainer.appendChild(toast); requestAnimationFrame(() => { toast.style.opacity = '1'; }); setTimeout(() => { if (toast.parentNode) { toast.style.opacity = '0'; setTimeout(() => { if (toast.parentNode) { toast.parentNode.removeChild(toast); } }, 500); } }, 3000); }
        function clearNotifications() { gameState.notifications = []; renderNotifications(); }

        // --- UI Rendering Functions ---
        function renderCatalogue() { catalogueList.innerHTML = ''; if (!Array.isArray(gameState.player.catalogue) || gameState.player.catalogue.length === 0) { catalogueList.innerHTML = '<p class="text-muted italic">No releases yet.</p>'; return; } gameState.player.catalogue.slice().reverse().forEach(item => { if (!item || typeof item !== 'object' || !item.title) return; const catalogueItem = document.createElement('div'); catalogueItem.className = 'bg-tertiary p-3 rounded-lg fade-in mb-2 catalogue-item'; catalogueItem.dataset.itemId = item.id; const isExpandable = (item.type === 'ep' || item.type === 'album') && Array.isArray(item.songs) && item.songs.length > 0; let detailsHtml = `<div class="flex items-center space-x-3 cursor-pointer catalogue-item-header"> <img src="${item.coverArt || DEFAULT_COVER_ART}" alt="${item.title} Cover" class="w-12 h-12 rounded object-cover bg-gray-600 flex-shrink-0"> <div class="flex-1 overflow-hidden"> <p class="font-semibold text-sm truncate" title="${item.title}">${item.title}</p> <p class="text-xs text-muted">${capitalizeFirstLetter(item.type || 'N/A')} - R: ${item.releaseDate || '??'}</p> <p class="text-xs text-blue-400"><i class="fas fa-headphones mr-1"></i> ${formatNumber(item.streams || 0)}</p> </div> <span class="text-sm font-medium bg-purple-600 px-2 py-1 rounded flex-shrink-0 whitespace-nowrap">Q: ${item.quality ?? '??'}</span> ${isExpandable ? `<button class="expand-catalogue-btn text-muted hover:text-primary p-1 text-xs ml-2" aria-expanded="false" title="Show/Hide Songs"><i class="fas fa-chevron-down icon-toggle"></i></button>` : ''} </div>`; if (isExpandable) { detailsHtml += `<div class="song-list mt-2 pt-2 border-t border-main pl-4 space-y-1"> ${item.songs.map(song => `<div class="flex justify-between items-center text-xs"> <span class="text-secondary truncate pr-2" title="${song.title}">${song.title || 'Track'}</span> <span class="text-blue-400 flex-shrink-0">${formatNumber(song.streams || 0)}</span> </div>`).join('')} </div>`; } catalogueItem.innerHTML = detailsHtml; catalogueList.appendChild(catalogueItem); }); }
        function toggleCatalogueItem(event) { const button = event.currentTarget; const catalogueItemDiv = button.closest('.catalogue-item'); const songListDiv = catalogueItemDiv?.querySelector('.song-list'); const icon = button.querySelector('.icon-toggle'); if (songListDiv && icon) { const isExpanded = songListDiv.classList.toggle('expanded'); button.setAttribute('aria-expanded', isExpanded); icon.classList.toggle('fa-chevron-down', !isExpanded); icon.classList.toggle('fa-chevron-up', isExpanded); } }
        function renderSocialFeed() { socialFeed.innerHTML = ''; if (!Array.isArray(gameState.socialFeed)) { return; } gameState.socialFeed.forEach(post => { if (!post || typeof post !== 'object' || !post.user || !post.content) { return; } const postElement = document.createElement('div'); postElement.className = 'bg-tertiary rounded-lg p-3 fade-in mb-2'; let avatarSrc = post.avatar || PLACEHOLDER_AVATAR_MALE; if (post.isPlayer && gameState.player.avatar?.startsWith('data:image')) { avatarSrc = gameState.player.avatar; } else if (typeof avatarSrc !== 'string' || (!avatarSrc.includes('http') && !avatarSrc.startsWith('data:image'))) { avatarSrc = PLACEHOLDER_AVATAR_MALE; } postElement.innerHTML = `<div class="flex items-center space-x-3 mb-2"> <img src="${avatarSrc}" class="w-8 h-8 rounded-full object-cover bg-gray-600"> <div> <p class="font-semibold text-sm">${post.user}</p> <p class="text-xs text-muted">${post.time || 'Just now'}</p> </div> </div> <p class="text-secondary text-sm mb-2 break-words">${post.content}</p> <div class="flex justify-start space-x-4 text-muted text-xs"> <span><i class="fas fa-heart mr-1"></i> ${post.likes || 0}</span> <span><i class="fas fa-comment mr-1"></i> ${post.comments || 0}</span> <span><i class="fas fa-share"></i></span> </div>`; socialFeed.appendChild(postElement); }); }
        function renderNotifications() { notificationsList.innerHTML = ''; if (!Array.isArray(gameState.notifications)) { return; } gameState.notifications.forEach(notification => { if (!notification || typeof notification !== 'object' || !notification.message) return; const el = document.createElement('div'); let borderColor = 'border-main'; let textColor = 'text-secondary'; const type = notification.type || 'info'; if (type === 'success') { borderColor = 'border-green-500'; textColor = 'text-green-300'; } else if (type === 'warning') { borderColor = 'border-yellow-500'; textColor = 'text-yellow-300'; } else if (type === 'milestone') { borderColor = 'border-purple-500'; textColor = 'text-purple-300'; } el.className = `bg-tertiary rounded-lg p-2 mb-2 border-l-4 ${borderColor} fade-in`; el.innerHTML = `<p class="text-sm ${textColor} break-words">${notification.message}</p><p class="text-xs text-muted mt-1 text-right">${notification.timestamp || ''}</p>`; notificationsList.appendChild(el); }); }
        function renderUpcomingEvents() { upcomingEvents.innerHTML = ''; if (!Array.isArray(gameState.upcomingEvents) || gameState.upcomingEvents.length === 0) { upcomingEvents.innerHTML = '<p class="text-muted italic text-sm">Nothing scheduled.</p>'; return; } gameState.upcomingEvents.forEach(event => { if (!event || typeof event !== 'object' || !event.title) return; const eventElement = document.createElement('div'); eventElement.className = 'bg-tertiary rounded-lg p-3 fade-in mb-2'; eventElement.innerHTML = `<div class="flex items-start space-x-3"> <div class="bg-purple-600 rounded-full p-2 w-8 h-8 flex items-center justify-center flex-shrink-0"> <i class="fas fa-${event.icon || 'question'} text-white text-xs"></i> </div> <div class="overflow-hidden"> <p class="font-semibold text-sm truncate" title="${event.title}">${event.title}</p> <p class="text-xs text-muted break-words">${event.description || ''}</p> </div> </div>`; upcomingEvents.appendChild(eventElement); }); }
        function updateAllUI() { if (!mainGame || mainGame.classList.contains('hidden')) { return; } try { updateSkillBars(); updateWellbeingBars(); updateStats(); renderSocialFeed(); renderNotifications(); renderUpcomingEvents(); updateProjectUI(); if (gameState.player.firstReleaseDone) { updateRealTimeStats(); } renderCatalogue(); } catch (error) { console.error("UI Update Error:", error); } }
        function updateProjectUI() { const project = gameState.currentProject; if (project && typeof project === 'object') { noProject.classList.add('hidden'); activeProject.classList.remove('hidden'); projectTitle.textContent = project.title || '...'; projectType.textContent = capitalizeFirstLetter(project.type || '?'); projectCoverPreview.src = project.coverArt || DEFAULT_COVER_ART; const progress = Math.round(project.progress || 0); projectProgressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`; projectProgressText.textContent = `${progress}%`; const stageIndex = project.currentStageIndex; const stages = project.stages || []; if(stages && stageIndex >= 0 && stageIndex < stages.length) { projectStage.textContent = stages[stageIndex]; } else { projectStage.textContent = progress >= 100 ? 'Finished' : '?'; } } else { noProject.classList.remove('hidden'); activeProject.classList.add('hidden'); } }
        function updateSkillBars() { vocalSkillBar.style.width = `${gameState.player.skills.vocal}%`; vocalSkillValue.textContent = `${Math.round(gameState.player.skills.vocal)}`; songwritingSkillBar.style.width = `${gameState.player.skills.songwriting}%`; songwritingSkillValue.textContent = `${Math.round(gameState.player.skills.songwriting)}`; productionSkillBar.style.width = `${gameState.player.skills.production}%`; productionSkillValue.textContent = `${Math.round(gameState.player.skills.production)}`; stageSkillBar.style.width = `${gameState.player.skills.stage}%`; stageSkillValue.textContent = `${Math.round(gameState.player.skills.stage)}`; }
        function updateWellbeingBars() { energyBar.style.width = `${gameState.player.wellbeing.energy}%`; energyValue.textContent = `${Math.round(gameState.player.wellbeing.energy)}`; mentalHealthBar.style.width = `${gameState.player.wellbeing.mentalHealth}%`; mentalHealthValue.textContent = `${Math.round(gameState.player.wellbeing.mentalHealth)}`; publicImageBar.style.width = `${gameState.player.wellbeing.publicImage}%`; publicImageValue.textContent = `${Math.round(gameState.player.wellbeing.publicImage)}`; }
        function updateStats() { subscriberCount.textContent = formatNumber(gameState.player.stats.subscribers); streamCount.textContent = formatNumber(gameState.player.stats.streams); incomeCount.textContent = formatNumber(gameState.player.stats.income, true); updateFameLevel(); }

        // --- Promotion Logic ---
        function startPromotion(type) { if (gameState.promotionEndTime > 0 && Date.now() < gameState.promotionEndTime) { addNotification("Campaign already active!", "warning"); return; } let cost = 0; let boost = 1; let duration = 0; let baseListeners = 0; if (type === 'social_media') { cost = PROMOTION_COST_SOCIAL; boost = PROMOTION_BOOST_SOCIAL; duration = PROMOTION_DURATION_SOCIAL; baseListeners = 50 + Math.random() * 100; } else { return; } const currentIncome = gameState.player.stats.income || 0; if (currentIncome < cost) { addNotification(`Need ${formatNumber(cost, true)}`, "warning"); return; } gameState.player.stats.income -= cost; gameState.promotionBoost = boost; gameState.promotionEndTime = Date.now() + duration; gameState.activeListeners = (gameState.activeListeners || 0) + Math.round(baseListeners * (1 + (gameState.player.stats.fameLevelNumeric || 0) / 5)); addNotification(`Started ${type.replace('_', ' ')} campaign! Growth boosted for ${formatDuration(duration)}.`, "success"); updateStats(); saveGame(); }

        // --- Event Listener Setup ---
        function setupEventListeners() {
             startGameBtn?.addEventListener('click', startGame);
             avatarUpload?.addEventListener('change', handleAvatarUpload);
             avatarOptions.forEach(option => option?.addEventListener('click', () => selectDefaultAvatar(option)));
             startProjectBtn?.addEventListener('click', openProjectModal);
             closeProjectModalBtn?.addEventListener('click', closeProjectModal);
             coverArtUpload?.addEventListener('change', handleCoverArtUpload);
             confirmProjectBtn?.addEventListener('click', createProject);
             projectTypeSelect?.addEventListener('change', (e) => updateSongTitlesUI(e.target.value));
             workOnProjectBtn?.addEventListener('click', workOnProject);
             cancelProjectBtn?.addEventListener('click', cancelProject);
             confirmReleaseBtn?.addEventListener('click', releaseProject);
             cancelReleaseBtn?.addEventListener('click', () => releaseModal?.classList.add('hidden'));
             practiceVocalsBtn?.addEventListener('click', () => practiceSkill('vocal'));
             writeSongBtn?.addEventListener('click', () => practiceSkill('songwriting'));
             produceTrackBtn?.addEventListener('click', () => practiceSkill('production'));
             restBtn?.addEventListener('click', rest);
             postUpdateBtn?.addEventListener('click', postUpdate);
             refreshFeedBtn?.addEventListener('click', refreshFeed);
             clearNotificationsBtn?.addEventListener('click', clearNotifications);
             settingsBtn?.addEventListener('click', () => settingsModal?.classList.remove('hidden'));
             closeSettingsModalBtn?.addEventListener('click', () => settingsModal?.classList.add('hidden'));
             resetProgressBtn?.addEventListener('click', resetGame);
             setupThemePickers();
             closeOfflineModalBtn?.addEventListener('click', () => offlineProgressModal?.classList.add('hidden'));
             promoteSocialMediaBtn?.addEventListener('click', () => startPromotion('social_media'));
             if (promoCostSocialSpan) promoCostSocialSpan.textContent = PROMOTION_COST_SOCIAL.toString(); // Set initial display
             catalogueList?.addEventListener('click', (event) => { const button = event.target.closest('.expand-catalogue-btn'); if (button) toggleCatalogueItem({ currentTarget: button }); });
             window.addEventListener('beforeunload', saveGame);
        }

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
             setupEventListeners();
             startGame(); // Load or start new game
         });

    </script>
</body>
</html>
